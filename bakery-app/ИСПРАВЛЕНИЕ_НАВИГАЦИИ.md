# ✅ Исправление ошибки навигации

## Проблема

Ошибка: **"Attempted to navigate before mounting the Root Layout component"**

Эта ошибка возникает, когда код пытается выполнить навигацию (например, `router.back()` или `router.replace()`) до того, как приложение полностью загрузилось и построило дерево экранов.

### Где возникала:
- При обновлении страницы авторизации
- При автоматическом редиректе авторизованного пользователя
- При попытке навигации в `useEffect` без проверки готовности

## Решение

Используем хук `useRootNavigationState()` для проверки готовности навигации перед любыми переходами.

### Принцип работы

```typescript
import { useRootNavigationState } from 'expo-router';

const navigationState = useRootNavigationState();

useEffect(() => {
  // 1. Ждем готовности навигации
  if (!navigationState?.key) {
    console.log('Navigation not ready yet...');
    return;
  }
  
  // 2. Только после готовности выполняем навигацию
  if (someCondition) {
    setTimeout(() => {
      router.replace('/some-route');
    }, 100);
  }
}, [navigationState, someCondition]);
```

## Исправленные файлы

### 1. `app/_layout.tsx`
**Было:** Редирект выполнялся сразу при изменении `session`

**Стало:** Добавлена проверка `!navigationState?.key`

```typescript
useEffect(() => {
  if (loading) return;
  
  // ✅ Проверка готовности навигации
  if (!navigationState?.key) {
    console.log('Navigation not ready yet...');
    return;
  }

  const inAuthGroup = segments[0] === 'auth';

  if (!session && !inAuthGroup && segments.length > 0) {
    setTimeout(() => router.replace('/auth/login'), 100);
  } else if (session && inAuthGroup) {
    setTimeout(() => router.replace('/(tabs)'), 100);
  }
}, [session, loading, segments, navigationState]);
```

### 2. `app/auth/login.tsx`
**Добавлено:** Проверка авторизации с ожиданием готовности навигации

```typescript
import { useRootNavigationState } from 'expo-router';

const { session } = useAuth();
const navigationState = useRootNavigationState();

useEffect(() => {
  // ✅ Ждем готовности навигации
  if (!navigationState?.key) return;
  
  // Если пользователь уже авторизован, перенаправляем
  if (session) {
    setTimeout(() => {
      router.replace('/(tabs)/home');
    }, 100);
  }
}, [session, navigationState]);
```

### 3. `app/auth/register.tsx`
**Добавлено:** Аналогичная проверка для регистрации

```typescript
import { useRootNavigationState } from 'expo-router';

const { session } = useAuth();
const navigationState = useRootNavigationState();

useEffect(() => {
  // ✅ Ждем готовности навигации
  if (!navigationState?.key) return;
  
  // Если пользователь уже авторизован, перенаправляем
  if (session) {
    setTimeout(() => {
      router.replace('/(tabs)/home');
    }, 100);
  }
}, [session, navigationState]);
```

## Почему это работает?

### Проблема
React Native работает очень быстро. Когда компонент монтируется, `useEffect` запускается мгновенно. Но `RootLayout` (навигация) может еще не успеть "примонтироваться".

### Решение
Проверка `if (!navigationState?.key) return;` буквально говорит:
> "Подожди, пока навигация полностью загрузится, и только потом пытайся переключать экраны"

### Дополнительная защита
`setTimeout(() => router.replace(...), 100)` добавляет небольшую задержку (100мс) для дополнительной безопасности.

## Как проверить исправление

### Тест 1: Обновление страницы авторизации
1. Откройте страницу логина
2. Нажмите F5 (обновить)
3. ✅ Ошибки не должно быть

### Тест 2: Автоматический редирект
1. Авторизуйтесь
2. Попробуйте открыть `/auth/login` напрямую
3. ✅ Должен автоматически перенаправить на главную без ошибок

### Тест 3: Быстрая навигация
1. Быстро переключайтесь между экранами
2. ✅ Ошибок навигации не должно быть

## Результат

✅ Ошибка "Attempted to navigate before mounting" исправлена
✅ Навигация работает стабильно
✅ Автоматические редиректы работают корректно
✅ Проверка готовности навигации добавлена во все критические места

## Дополнительные рекомендации

### Всегда используйте эту проверку при:
1. Автоматических редиректах в `useEffect`
2. Условной навигации при загрузке
3. Проверке авторизации с редиректом

### Шаблон для копирования:
```typescript
import { useRootNavigationState } from 'expo-router';

const navigationState = useRootNavigationState();

useEffect(() => {
  // Ждем готовности навигации
  if (!navigationState?.key) return;
  
  // Ваша логика навигации
  if (condition) {
    setTimeout(() => {
      router.replace('/route');
    }, 100);
  }
}, [navigationState, condition]);
```

## Ссылки

- [Expo Router - Navigation State](https://docs.expo.dev/router/reference/hooks/#userootnavigationstate)
- [React Navigation - Navigation Lifecycle](https://reactnavigation.org/docs/navigation-lifecycle/)

---

**Дата исправления:** 3 декабря 2025  
**Статус:** ✅ Исправлено и протестировано

