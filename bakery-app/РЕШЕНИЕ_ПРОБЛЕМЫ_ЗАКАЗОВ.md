# ✅ Решение проблемы с исчезновением заказов

## Проблема
Заказ не исчезал из "Активных" после обновления статуса в БД, хотя:
- Таймер срабатывал
- Статус обновлялся в БД
- Уведомления приходили

## Причина
Список заказов обновлялся каждую секунду из БД, но:
1. Обновление БД могло занимать время
2. Между обновлением статуса и следующим запросом проходила секунда
3. Не было принудительного обновления сразу после изменения

## Решение
Добавлена глобальная функция `refreshOrders()` для принудительного обновления списка заказов сразу после изменения статуса.

### Как это работает

#### 1. В orders.tsx регистрируем функцию
```typescript
useEffect(() => {
  // Регистрируем глобальную функцию
  (global as any).refreshOrders = () => {
    console.log('[ЗАКАЗЫ] Принудительное обновление');
    loadOrders(); // Загружаем заказы из БД
  };
  
  return () => {
    // Очищаем при размонтировании
    delete (global as any).refreshOrders;
  };
}, []);
```

#### 2. В cart.tsx вызываем после обновления
```typescript
// Обновили статус в БД
await supabase
  .from('orders')
  .update({ status: 'delivered' })
  .eq('id', savedOrderId);

// Сразу обновляем список заказов
if ((global as any).refreshOrders) {
  (global as any).refreshOrders();
}
```

## Что происходит теперь

### Временная шкала
```
0:00 - Оформление заказа
       ├─ Создание в БД (status: pending)
       ├─ Появление в "Активных"
       └─ Запуск таймера на 60 сек

0:01-0:59 - Ожидание
       └─ Автообновление каждую секунду

1:00 - Доставка
       ├─ Обновление БД (status: delivered)
       ├─ Вызов global.refreshOrders()
       ├─ Немедленная загрузка из БД
       ├─ Заказ исчезает из "Активных"
       ├─ Заказ появляется в "Истории"
       └─ Автопереключение вкладки
```

## Логи в консоли

### При обновлении статуса
```
[ЗАКАЗ] Обновляем статус заказа #F50F500F на "delivered"...
[ЗАКАЗ] Order ID для обновления: xxx
[ЗАКАЗ] Статус обновлён на "delivered" [{...}]
[ЗАКАЗ] Вызываем глобальную функцию обновления заказов
[ЗАКАЗЫ] Принудительное обновление через глобальную функцию
[ЗАКАЗЫ] Загружено 3 заказов
[ЗАКАЗЫ] Вкладка: active, Всего: 3, Активных: 0, История: 3
```

## Преимущества решения

✅ **Немедленное обновление** - не ждём следующего автообновления
✅ **Надёжность** - работает даже если автообновление отключено
✅ **Простота** - не требует сложных state management решений
✅ **Совместимость** - работает с существующей архитектурой

## Альтернативные решения

### 1. React Context (сложнее)
Создать OrdersContext с функцией refresh

### 2. Event Emitter (избыточно)
Использовать библиотеку для событий

### 3. Polling с меньшим интервалом (неэффективно)
Обновлять каждые 100мс вместо 1000мс

## Изменённые файлы

- `app/(tabs)/orders.tsx` - Регистрация global.refreshOrders
- `app/(tabs)/cart.tsx` - Вызов global.refreshOrders после обновления

## Результат

✅ Заказ исчезает из "Активных" сразу после доставки
✅ Заказ появляется в "Истории" мгновенно
✅ Автопереключение на вкладку "История"
✅ Все уведомления работают корректно
