# ‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç

## –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### 1. **AsyncStorage –≤–º–µ—Å—Ç–æ localStorage**
- –ó–∞–º–µ–Ω–∏–ª `localStorage` –Ω–∞ `AsyncStorage` –≤ `supabase.ts`
- –¢–µ–ø–µ—Ä—å —Å–µ—Å—Å–∏–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤ React Native/Expo

### 2. **–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞**
- –î–æ–±–∞–≤–ª–µ–Ω `AppState.addEventListener` –¥–ª—è –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
- –¢–æ–∫–µ–Ω –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏–∑ —Ñ–æ–Ω–∞

### 3. **–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Å—Å–∏–∏**
- –í `AuthContext.tsx` –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Å—Å–∏–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
- –°–µ—Å—Å–∏—è –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

### 4. **–†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏**
- –í `_layout.tsx` –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞:
  - –ï—Å–ª–∏ –Ω–µ—Ç —Å–µ—Å—Å–∏–∏ ‚Üí —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ `/welcome`
  - –ï—Å–ª–∏ –µ—Å—Ç—å —Å–µ—Å—Å–∏—è ‚Üí —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ `/(tabs)/home`
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –≤–æ –≤—Ä–µ–º—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ—Å—Å–∏–∏

### 5. **–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ —à–∞–ø–∫–µ**
- –î–æ–±–∞–≤–ª–µ–Ω –±–µ–π–¥–∂ –≤ —à–∞–ø–∫–µ –≥–ª–∞–≤–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞:
  - ‚úÖ **"–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω"** (–∑–µ–ª–µ–Ω—ã–π) - –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ª–æ–≥–∏–Ω–µ–Ω
  - üë§ **"–ì–æ—Å—Ç—å"** (—Å–µ—Ä—ã–π) - –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –§–∞–π–ª: `src/lib/supabase.ts`
```typescript
import AsyncStorage from '@react-native-async-storage/async-storage';
import { AppState } from 'react-native';

// AsyncStorage –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏
const customStorage = {
  getItem: async (key: string) => await AsyncStorage.getItem(key),
  setItem: async (key: string, value: string) => await AsyncStorage.setItem(key, value),
  removeItem: async (key: string) => await AsyncStorage.removeItem(key),
};

export const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: {
    storage: customStorage, // ‚Üê –ò—Å–ø–æ–ª—å–∑—É–µ–º AsyncStorage
    autoRefreshToken: true,
    persistSession: true,
    detectSessionInUrl: false,
  },
});

// –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
AppState.addEventListener('change', (state) => {
  if (state === 'active') {
    supabase.auth.startAutoRefresh();
  } else {
    supabase.auth.stopAutoRefresh();
  }
});
```

### –§–∞–π–ª: `src/context/AuthContext.tsx`
```typescript
useEffect(() => {
  // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Å—Å–∏–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
  const fetchSession = async () => {
    const { data: { session } } = await supabase.auth.getSession();
    setSession(session);
    setUser(session?.user ?? null);
    if (session?.user) {
      await loadProfile(session.user.id);
    }
    setLoading(false);
  };

  fetchSession();

  // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  const { data: { subscription } } = supabase.auth.onAuthStateChange(
    async (event, session) => {
      setSession(session);
      setUser(session?.user ?? null);
      if (session?.user) {
        await loadProfile(session.user.id);
      } else {
        setProfile(null);
      }
      setLoading(false);
    }
  );

  return () => subscription.unsubscribe();
}, []);
```

### –§–∞–π–ª: `app/_layout.tsx`
```typescript
function InitialLayout() {
  const { session, loading } = useAuth();
  const segments = useSegments();
  const router = useRouter();

  useEffect(() => {
    if (loading) return; // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏

    const inAuthGroup = segments[0] === 'auth';

    if (!session && !inAuthGroup) {
      router.replace('/welcome'); // –ù–µ—Ç —Å–µ—Å—Å–∏–∏ ‚Üí –Ω–∞ welcome
    } else if (session && inAuthGroup) {
      router.replace('/(tabs)/home'); // –ï—Å—Ç—å —Å–µ—Å—Å–∏—è ‚Üí –Ω–∞ home
    }
  }, [session, loading, segments]);

  if (loading) {
    return <ActivityIndicator />; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
  }

  return <Slot />;
}
```

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

### –í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –≤–∏–¥–Ω–æ:
```
‚úÖ Storage GET: sb-qkyhwdmhkoizxjazwnti-auth-token Found
‚úÖ AuthContext: Initializing...
‚úÖ AuthContext: Loading session...
‚úÖ AuthContext: Session found, loading profile...
‚úÖ Auth state changed: SIGNED_IN
‚úÖ New session: Present
‚úÖ User in event: vanya.piskunov.95@list.ru
‚úÖ Loading profile for user: 095d85ac-6057-4cbf-bcc7-f4a5aa63d17d
```

### –ù–∞ —ç–∫—Ä–∞–Ω–µ:
- –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: **–ò–≤–∞–Ω**
- –ë–æ–Ω—É—Å—ã: **250 –±–∞–ª–ª–æ–≤**
- –ë–µ–π–¥–∂: **‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω** (–∑–µ–ª–µ–Ω—ã–π)

## –ß—Ç–æ –¥–∞–ª—å—à–µ?

–¢–µ–ø–µ—Ä—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é:
- ‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –í—Ö–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –°–µ—Å—Å–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–∞—Ç—É—Å–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- ‚úÖ –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
- ‚úÖ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –∏–∑ —Ñ–æ–Ω–∞

–ú–æ–∂–µ—à—å —Å–ø–æ–∫–æ–π–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º! üéâ
