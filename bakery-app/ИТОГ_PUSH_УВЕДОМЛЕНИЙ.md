# 🔔 ИТОГ: Push-уведомления для закрытого приложения

## ✅ Что сделано

### 1. Обновлён код приложения

**src/utils/notifications.ts**
- ✅ Добавлена функция `registerForPushNotificationsAsync(userId)` - регистрирует FCM токен
- ✅ Добавлена функция `saveFCMToken()` - сохраняет токен в Supabase
- ✅ Добавлена функция `removeFCMToken()` - удаляет токен при выходе
- ✅ Поддержка expo-device для определения устройства

**app/_layout.tsx**
- ✅ Регистрация FCM токена при входе пользователя
- ✅ Передача userId в функцию регистрации

**src/context/AuthContext.tsx**
- ✅ Удаление FCM токена при выходе из аккаунта
- ✅ Очистка токенов перед signOut

**app/support.tsx**
- ✅ Локальные уведомления когда приложение открыто (уже работает)
- ✅ Отслеживание состояния приложения (AppState)

### 2. Созданы файлы для настройки

| Файл | Описание |
|------|----------|
| `НАСТРОЙКА_PUSH_БД.sql` | SQL скрипт для создания таблиц, политик и триггеров |
| `supabase-edge-function-send-push.ts` | Код Edge Function для отправки push через Firebase |
| `install-push-packages.bat` | Скрипт установки пакетов |
| `PUSH_УВЕДОМЛЕНИЯ_ИНСТРУКЦИЯ.md` | Подробная инструкция по настройке |
| `ДЕЛАЙ_СЕЙЧАС_PUSH.md` | Пошаговый чеклист |
| `БЫСТРЫЙ_СТАРТ_PUSH.md` | Краткая шпаргалка на 30 минут |
| `PUSH_ГОТОВО.md` | Обзор всех изменений |

### 3. Установлены пакеты

```json
"expo-device": "~5.8.0",
"expo-application": "~5.8.0"
```

---

## 🎯 Что нужно сделать ТЕБЕ

### Открой файл: **БЫСТРЫЙ_СТАРТ_PUSH.md**

Там пошаговая инструкция на 30 минут:

1. ⚙️ Настроить Firebase (10 мин)
2. 🗄️ Настроить Supabase БД (5 мин)
3. ☁️ Создать Edge Function (5 мин)
4. 📱 Обновить Expo Project ID (1 мин)
5. 🔨 Собрать новый APK (5 мин)

---

## 📊 Архитектура решения

```
┌─────────────────────────────────────────────────────────┐
│                    ПРИЛОЖЕНИЕ ОТКРЫТО                    │
├─────────────────────────────────────────────────────────┤
│  Админ → Supabase → Realtime → App → Local Notification │
│                                                           │
│  ✅ УЖЕ РАБОТАЕТ                                         │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│                    ПРИЛОЖЕНИЕ ЗАКРЫТО                    │
├─────────────────────────────────────────────────────────┤
│  Админ → Supabase → Database Trigger → Edge Function    │
│         → Firebase → Push Notification → Телефон         │
│                                                           │
│  ⚙️ НУЖНО НАСТРОИТЬ                                      │
└─────────────────────────────────────────────────────────┘
```

---

## 🗄️ База данных

### Новая таблица: `user_fcm_tokens`

```sql
CREATE TABLE user_fcm_tokens (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id),
  fcm_token TEXT NOT NULL,
  device_info TEXT,
  created_at TIMESTAMP,
  updated_at TIMESTAMP,
  UNIQUE(user_id, fcm_token)
);
```

### Триггер: `on_support_message_insert`

Автоматически срабатывает при новом сообщении от админа:
1. Получает FCM токены пользователя
2. Вызывает Edge Function
3. Edge Function отправляет push через Firebase

---

## 🔥 Два типа уведомлений

| Тип | Когда | Технология | Статус |
|-----|-------|------------|--------|
| **Локальные** | Приложение открыто | expo-notifications | ✅ Работает |
| **Push** | Приложение закрыто | Firebase FCM | ⚙️ Нужно настроить |

---

## 📝 Важные ссылки

- Firebase Console: https://console.firebase.google.com/
- Supabase Dashboard: https://supabase.com/dashboard
- Expo Dashboard: https://expo.dev

---

## 🧪 Как протестировать

1. Установи новый APK на телефон
2. Войди в приложение (токен зарегистрируется)
3. Проверь в Supabase: Table Editor → `user_fcm_tokens` (должна быть запись)
4. **Закрой приложение полностью** (свайп из недавних)
5. Открой `admin-chat.html` в браузере
6. Отправь сообщение пользователю
7. Push-уведомление должно прийти на телефон! 🔔

---

## ❓ Troubleshooting

### Токен не сохраняется
- Проверь что пользователь авторизован
- Проверь логи: `console.log` в `registerForPushNotificationsAsync`
- Проверь RLS политики в Supabase

### Push не приходит
- Проверь Edge Function: Supabase → Edge Functions → Logs
- Проверь Firebase: Cloud Messaging → Reports
- Проверь Server Key правильный
- Проверь токен валидный (не истёк)

### Ошибка в триггере
- Проверь заменил ли `YOUR_PROJECT_REF` и `YOUR_ANON_KEY`
- Проверь Edge Function задеплоена
- Проверь логи в Supabase

---

## 🎉 Результат

После настройки у тебя будет:

✅ **Локальные уведомления** - когда приложение открыто, но пользователь не в чате  
✅ **Push-уведомления** - когда приложение полностью закрыто  
✅ **Автоматическая отправка** - через Database Trigger  
✅ **Поддержка нескольких устройств** - один пользователь может иметь несколько токенов  
✅ **Очистка токенов** - при выходе из аккаунта  

---

## 🚀 Начни с файла: БЫСТРЫЙ_СТАРТ_PUSH.md

Удачи! 💪
