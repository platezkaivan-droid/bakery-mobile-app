<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è - –ü–µ–∫–∞—Ä–Ω—è –ü–∞–≤–ª–æ–≤–∞</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .container {
      background: white;
      border-radius: 24px;
      padding: 40px;
      max-width: 400px;
      width: 100%;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0,0,0,0.2);
    }
    
    .logo {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 24px;
      font-size: 40px;
    }
    
    h1 {
      color: #333;
      font-size: 24px;
      margin-bottom: 12px;
    }
    
    p {
      color: #666;
      font-size: 16px;
      margin-bottom: 24px;
      line-height: 1.5;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #FF6B35;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 24px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .btn {
      display: inline-block;
      background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
      color: white;
      padding: 14px 32px;
      border-radius: 12px;
      text-decoration: none;
      font-weight: 600;
      font-size: 16px;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(255, 107, 53, 0.4);
    }
    
    .status {
      margin-top: 20px;
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
    }
    
    .status.success {
      background: #e8f5e9;
      color: #2e7d32;
    }
    
    .status.error {
      background: #ffebee;
      color: #c62828;
    }
    
    .status.info {
      background: #e3f2fd;
      color: #1565c0;
    }
    
    #manual-link {
      display: none;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">ü•ê</div>
    <h1 id="title">–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...</h1>
    <p id="message">–ü–æ–¥–æ–∂–¥–∏—Ç–µ, –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</p>
    <div class="spinner" id="spinner"></div>
    
    <div id="status-container"></div>
    
    <div id="manual-link">
      <p>–ï—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –æ—Ç–∫—Ä—ã–ª–æ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:</p>
      <a href="#" class="btn" id="open-app-btn">–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</a>
    </div>
  </div>

  <script>
    // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
    const hash = window.location.hash.substring(1);
    const search = window.location.search.substring(1);
    const params = new URLSearchParams(hash || search);
    
    // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–∫–µ–Ω—ã
    const accessToken = params.get('access_token');
    const refreshToken = params.get('refresh_token');
    const tokenHash = params.get('token_hash');
    const token = params.get('token');
    const type = params.get('type');
    const error = params.get('error');
    const errorDescription = params.get('error_description');
    
    console.log('üîê Auth Callback Page');
    console.log('Parameters:', {
      hasAccessToken: !!accessToken,
      hasRefreshToken: !!refreshToken,
      hasTokenHash: !!tokenHash,
      hasToken: !!token,
      type,
      error
    });
    
    function showStatus(message, type) {
      const container = document.getElementById('status-container');
      container.innerHTML = `<div class="status ${type}">${message}</div>`;
    }
    
    function showManualLink(url) {
      document.getElementById('manual-link').style.display = 'block';
      document.getElementById('open-app-btn').href = url;
      document.getElementById('spinner').style.display = 'none';
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
    if (error) {
      document.getElementById('title').textContent = '–û—à–∏–±–∫–∞';
      document.getElementById('message').textContent = errorDescription || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏';
      document.getElementById('spinner').style.display = 'none';
      showStatus(errorDescription || error, 'error');
    } else {
      // –§–æ—Ä–º–∏—Ä—É–µ–º Deep Link URL
      let deepLinkUrl = 'bakery-app://auth-callback';
      const deepLinkParams = [];
      
      if (accessToken) deepLinkParams.push(`access_token=${accessToken}`);
      if (refreshToken) deepLinkParams.push(`refresh_token=${refreshToken}`);
      if (tokenHash) deepLinkParams.push(`token_hash=${tokenHash}`);
      if (token) deepLinkParams.push(`token=${token}`);
      if (type) deepLinkParams.push(`type=${type}`);
      
      if (deepLinkParams.length > 0) {
        deepLinkUrl += '?' + deepLinkParams.join('&');
      }
      
      console.log('üîó Deep Link URL:', deepLinkUrl);
      
      // –ü—Ä–æ–±—É–µ–º –æ—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
      let appOpened = false;
      
      // –ú–µ—Ç–æ–¥ 1: –ü—Ä—è–º–æ–π —Ä–µ–¥–∏—Ä–µ–∫—Ç
      setTimeout(() => {
        if (!appOpened) {
          window.location.href = deepLinkUrl;
        }
      }, 100);
      
      // –ú–µ—Ç–æ–¥ 2: –ß–µ—Ä–µ–∑ iframe (–¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤)
      setTimeout(() => {
        if (!appOpened) {
          const iframe = document.createElement('iframe');
          iframe.style.display = 'none';
          iframe.src = deepLinkUrl;
          document.body.appendChild(iframe);
        }
      }, 500);
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä—É—á–Ω—É—é —Å—Å—ã–ª–∫—É —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
      setTimeout(() => {
        document.getElementById('title').textContent = '–ü–æ—á—Ç–∏ –≥–æ—Ç–æ–≤–æ!';
        document.getElementById('message').textContent = '–ï—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –æ—Ç–∫—Ä—ã–ª–æ—Å—å, –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ';
        showManualLink(deepLinkUrl);
        showStatus('‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.', 'success');
      }, 2000);
      
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã–ª–æ—Å—å (—Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–∫—Ä—ã–ª–∞—Å—å)
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
          appOpened = true;
        }
      });
    }
  </script>
</body>
</html>
