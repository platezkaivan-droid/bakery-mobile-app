# 🏗️ Архитектура приложения "Пекарня"

## 📐 Общая схема

```
┌─────────────────────────────────────────────────────────────┐
│                     Пользователь                             │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│                  Welcome Screen (index.tsx)                  │
│  ┌──────────┐  ┌──────────┐  ┌────────────────────────┐   │
│  │  Войти   │  │Регистр.  │  │ Продолжить как гость   │   │
│  └──────────┘  └──────────┘  └────────────────────────┘   │
└────────────────────┬────────────────────────────────────────┘
                     │
        ┌────────────┴────────────┐
        │                         │
        ▼                         ▼
┌──────────────┐         ┌──────────────┐
│ Auth Screen  │         │  Main App    │
│              │         │   (Tabs)     │
│ - Login      │         │              │
│ - Register   │         │ - Home       │
│              │         │ - Cart       │
│              │         │ - Favorites  │
│              │         │ - Orders     │
│              │         │ - Profile    │
└──────────────┘         └──────────────┘
        │                         │
        └────────────┬────────────┘
                     │
                     ▼
        ┌────────────────────────┐
        │   Supabase Backend     │
        │                        │
        │ - Auth (JWT)           │
        │ - PostgreSQL           │
        │ - RLS Policies         │
        └────────────────────────┘
```

---

## 🔄 Поток авторизации

```
┌──────────────┐
│   Пользователь│
└───────┬──────┘
        │
        │ 1. Вход (email/password)
        ▼
┌──────────────────────┐
│  AuthContext         │
│  signIn()            │
└───────┬──────────────┘
        │
        │ 2. Запрос к Supabase
        ▼
┌──────────────────────┐
│  Supabase Auth       │
│  signInWithPassword()│
└───────┬──────────────┘
        │
        │ 3. Возврат Session + JWT
        ▼
┌──────────────────────┐
│  AsyncStorage        │
│  Сохранение сессии   │
└───────┬──────────────┘
        │
        │ 4. Обновление состояния
        ▼
┌──────────────────────┐
│  AuthContext         │
│  setUser(user)       │
│  setSession(session) │
└───────┬──────────────┘
        │
        │ 5. Редирект
        ▼
┌──────────────────────┐
│  _layout.tsx         │
│  router.replace()    │
└───────┬──────────────┘
        │
        ▼
┌──────────────────────┐
│  Main App (Tabs)     │
└──────────────────────┘
```

---

## 🗂️ Структура данных

### Контексты (Context API)

```
RootLayout (_layout.tsx)
│
├── SettingsProvider
│   └── Тёмная/светлая тема, язык
│
├── AuthProvider
│   ├── user (User | null)
│   ├── profile (Profile | null)
│   ├── session (Session | null)
│   ├── loading (boolean)
│   └── Методы: signIn, signUp, signOut, updateProfile
│
├── DemoBonusProvider
│   └── Бонусы для гостей
│
├── FavoritesProvider
│   ├── favorites (Product[])
│   └── Методы: addToFavorites, removeFromFavorites
│
├── CartProvider
│   ├── items (CartItem[])
│   ├── itemCount (number)
│   ├── total (number)
│   └── Методы: addToCart, removeFromCart, updateQuantity
│
└── NotificationProvider
    └── Методы: showNotification
```

---

## 🗄️ База данных Supabase

### Схема таблиц

```sql
┌─────────────────────────────────────────────────────────┐
│                      auth.users                          │
│  (Встроенная таблица Supabase Auth)                     │
├─────────────────────────────────────────────────────────┤
│  id (UUID) - PRIMARY KEY                                 │
│  email (TEXT)                                            │
│  encrypted_password (TEXT)                               │
│  created_at (TIMESTAMP)                                  │
└────────────────────┬────────────────────────────────────┘
                     │
                     │ 1:1
                     ▼
┌─────────────────────────────────────────────────────────┐
│                      profiles                            │
│  (Профили пользователей)                                │
├─────────────────────────────────────────────────────────┤
│  id (UUID) - PRIMARY KEY, FK → auth.users.id            │
│  email (TEXT)                                            │
│  full_name (TEXT)                                        │
│  phone (TEXT)                                            │
│  avatar_url (TEXT) - Base64 изображение                 │
│  bonus_points (INTEGER) - DEFAULT 0                      │
│  loyalty_level (TEXT) - DEFAULT 'bronze'                 │
│  created_at (TIMESTAMP)                                  │
└────────────────────┬────────────────────────────────────┘
                     │
                     │ 1:N
                     ▼
┌─────────────────────────────────────────────────────────┐
│                      favorites                           │
│  (Избранные товары)                                     │
├─────────────────────────────────────────────────────────┤
│  id (UUID) - PRIMARY KEY                                 │
│  user_id (UUID) - FK → profiles.id                       │
│  product_id (UUID) - FK → products.id                    │
│  created_at (TIMESTAMP)                                  │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│                      products                            │
│  (Товары)                                               │
├─────────────────────────────────────────────────────────┤
│  id (UUID) - PRIMARY KEY                                 │
│  name (TEXT)                                             │
│  description (TEXT)                                      │
│  price (NUMERIC)                                         │
│  image_url (TEXT)                                        │
│  category_id (UUID) - FK → categories.id                 │
│  rating (NUMERIC) - DEFAULT 5.0                          │
│  created_at (TIMESTAMP)                                  │
└────────────────────┬────────────────────────────────────┘
                     │
                     │ N:1
                     ▼
┌─────────────────────────────────────────────────────────┐
│                      categories                          │
│  (Категории товаров)                                    │
├─────────────────────────────────────────────────────────┤
│  id (UUID) - PRIMARY KEY                                 │
│  name (TEXT) - Выпечка, Торты, Пирожные, Хлеб, Десерты │
│  icon (TEXT)                                             │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│                      orders                              │
│  (Заказы)                                               │
├─────────────────────────────────────────────────────────┤
│  id (UUID) - PRIMARY KEY                                 │
│  user_id (UUID) - FK → profiles.id                       │
│  status (TEXT) - pending, preparing, delivering, delivered│
│  total (NUMERIC)                                         │
│  delivery_address (TEXT)                                 │
│  courier_lat (NUMERIC)                                   │
│  courier_lng (NUMERIC)                                   │
│  created_at (TIMESTAMP)                                  │
└─────────────────────────────────────────────────────────┘
```

### RLS Политики

```sql
-- Профили: пользователи видят только свой профиль
CREATE POLICY "Users can view own profile"
ON profiles FOR SELECT
USING (auth.uid() = id);

CREATE POLICY "Users can update own profile"
ON profiles FOR UPDATE
USING (auth.uid() = id);

-- Избранное: пользователи видят только своё избранное
CREATE POLICY "Users can view own favorites"
ON favorites FOR SELECT
USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own favorites"
ON favorites FOR INSERT
WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can delete own favorites"
ON favorites FOR DELETE
USING (auth.uid() = user_id);

-- Товары: все могут читать
CREATE POLICY "Anyone can view products"
ON products FOR SELECT
TO public
USING (true);

-- Заказы: пользователи видят только свои заказы
CREATE POLICY "Users can view own orders"
ON orders FOR SELECT
USING (auth.uid() = user_id);
```

---

## 🎨 Компоненты и экраны

### Иерархия компонентов

```
App
│
├── _layout.tsx (Root)
│   ├── SettingsProvider
│   ├── AuthProvider
│   ├── DemoBonusProvider
│   ├── FavoritesProvider
│   ├── CartProvider
│   └── NotificationProvider
│
├── index.tsx (Welcome Screen)
│   ├── Logo
│   ├── Features
│   └── Buttons (Login, Register, Guest)
│
├── auth/
│   ├── login.tsx
│   │   ├── Input (Email)
│   │   ├── Input (Password)
│   │   └── Button (Login)
│   │
│   └── register.tsx
│       ├── Input (Email)
│       ├── Input (Password)
│       ├── Input (Full Name)
│       ├── Input (Phone)
│       └── Button (Register)
│
└── (tabs)/
    ├── _layout.tsx (Tab Navigator)
    │
    ├── home.tsx
    │   ├── Header
    │   │   ├── Avatar
    │   │   ├── Greeting
    │   │   └── Icons (Notifications, Cart)
    │   ├── PromoBanner (Бонусы)
    │   ├── SearchBar
    │   ├── Stories (Новинки, Акции, Рецепты, Советы)
    │   ├── Categories
    │   └── ProductsGrid
    │       └── ProductCard (x24)
    │           ├── Image
    │           ├── Name
    │           ├── Rating
    │           ├── Price
    │           └── AddButton
    │
    ├── cart.tsx
    │   ├── Header
    │   ├── CartItems
    │   │   └── CartItem
    │   │       ├── Image
    │   │       ├── Name
    │   │       ├── Price
    │   │       └── QuantityControls
    │   ├── Summary (Total)
    │   └── CheckoutButton
    │
    ├── favorites.tsx
    │   ├── Header
    │   └── FavoritesList
    │       └── ProductCard
    │
    ├── orders.tsx
    │   ├── Header
    │   └── OrdersList
    │       └── OrderCard
    │           ├── Order Number
    │           ├── Status
    │           ├── Items
    │           └── Total
    │
    └── profile.tsx
        ├── Header
        ├── Avatar
        ├── UserInfo (Name, Email, Phone)
        ├── BonusCard
        ├── Settings
        │   └── ThemeToggle
        └── LogoutButton
```

---

## 🔐 Безопасность

### Уровни защиты

```
1. Frontend (React Native)
   ├── AuthContext проверяет наличие session
   ├── _layout.tsx редиректит неавторизованных
   └── Компоненты скрывают функции для гостей

2. Supabase Auth (JWT)
   ├── Токены с истечением срока
   ├── Автоматическое обновление токенов
   └── Хранение в AsyncStorage (зашифровано)

3. Database (RLS Policies)
   ├── Пользователи видят только свои данные
   ├── Запрещено изменение чужих записей
   └── Публичный доступ только к товарам
```

---

## 📦 Управление состоянием

### Локальное состояние (useState)
- Форма ввода
- Модальные окна
- Временные UI состояния

### Контекст (Context API)
- Авторизация (AuthContext)
- Корзина (CartContext)
- Избранное (FavoritesContext)
- Настройки (SettingsContext)

### Серверное состояние (Supabase)
- Профили пользователей
- Товары
- Заказы
- Избранное (синхронизация)

---

## 🚀 Производительность

### Оптимизации

1. **Изображения**
   - Локальные require() для быстрой загрузки
   - Сжатие качества (quality: 0.5)
   - Lazy loading для списков

2. **Списки**
   - FlatList с keyExtractor
   - Виртуализация (только видимые элементы)
   - Мемоизация компонентов (React.memo)

3. **Навигация**
   - Expo Router (file-based)
   - Предзагрузка экранов
   - Кеширование состояния

4. **База данных**
   - Индексы на часто запрашиваемых полях
   - RLS для фильтрации на уровне БД
   - Подписки (realtime) только где нужно

---

## 🔄 Жизненный цикл приложения

```
1. Запуск приложения
   ↓
2. Инициализация провайдеров (_layout.tsx)
   ↓
3. Проверка сессии (AuthContext)
   ├─ Есть сессия → Загрузка профиля → Main App
   └─ Нет сессии → Welcome Screen
   ↓
4. Пользователь взаимодействует
   ├─ Добавляет товар в корзину → CartContext
   ├─ Добавляет в избранное → FavoritesContext + Supabase
   └─ Меняет тему → SettingsContext
   ↓
5. Выход из приложения
   └─ Сессия сохраняется в AsyncStorage
   ↓
6. Повторный запуск
   └─ Сессия восстанавливается → Автоматический вход
```

---

## 📱 Адаптивность

### Поддерживаемые платформы

```
┌─────────────────────────────────────────┐
│           React Native Core             │
├─────────────────────────────────────────┤
│  ┌─────────┐  ┌─────────┐  ┌─────────┐ │
│  │   iOS   │  │ Android │  │   Web   │ │
│  └─────────┘  └─────────┘  └─────────┘ │
└─────────────────────────────────────────┘
```

### Адаптация UI

- **iOS**: Нативные компоненты (SafeAreaView)
- **Android**: Material Design элементы
- **Web**: Адаптивная вёрстка (flexbox)

---

## 🎯 Следующие шаги архитектуры

### Планируемые улучшения:

1. **State Management**
   - Переход на Redux Toolkit или Zustand
   - Централизованное управление состоянием

2. **Кеширование**
   - React Query для серверных данных
   - Оптимистичные обновления

3. **Оффлайн режим**
   - AsyncStorage для кеша товаров
   - Синхронизация при подключении

4. **Аналитика**
   - Firebase Analytics
   - Отслеживание действий пользователей

5. **Тестирование**
   - Jest для unit-тестов
   - Detox для E2E тестов

---

**Дата**: 3 декабря 2025  
**Версия**: 1.0.0  
**Статус**: ✅ Актуальная архитектура
